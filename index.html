<!DOCTYPE html>
<html>
<head>
<title>Minecraft Enchantment Simulator</title>

<script type="text/javascript" src="jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="enchantments.js"></script>
<script type="text/javascript" src="page.js"></script>
<script type="text/javascript" src="mc.js"></script>

<script type="text/javascript">
var defaultSimulationValue = "200/25";
$(document).ready(function()
{
	$("#trials")[0].value = defaultSimulationValue;
	simulate();
});

function simulate()
{
	clear();

	var statsSimulateEnchantment = new Object;
	var statsEnchantmentCount = new Object();
	
	var totalEnchantments = 0;
	var data = getInputData();
	var baseLevel = getBaseEnchantmentLevel( data.itemId, data.materialId );
	write( "Base enchantment level for tool: " + baseLevel );
	if( baseLevel <= 0 )
	{
		write( "Not enchantable!" );
		return;
	}
	write( "Simulating enchanting " + data.material + " " + data.item + " " + data.iterations + " times over " + data.simulations +" series." );
	for( var sim = 0; sim < data.simulations; sim++)
	{
		for( var iter = 0; iter<data.iterations; iter++)
		{
			var results = simulateEnchantments(data.itemId, data.materialId, data.level);
			totalEnchantments += results.length;

			ensureVar( statsEnchantmentCount, results.length, { sum:0, sqsum:0, x:0, n:0 } );
			statsEnchantmentCount[results.length].x++;

			for( var i = 0; i<results.length; i++ )
			{
				var result = results[i];
				ensureStatsVars( statsSimulateEnchantment, result );
				statsSimulateEnchantment[result.enchantment.id][result.enchantmentLevel].x++;
			}
		}

		updateSum(statsEnchantmentCount);
		for( var id in statsSimulateEnchantment )
			updateSum( statsSimulateEnchantment[id] );
	}
	write( "Done, presenting data..." );
	
	var maxHeight = 240;
	var columnCount = 0;
	var columnWidth = 23;
	write( "Enchantment count saturation: " + totalEnchantments / (data.simulations*data.iterations) );
	for( var count in statsEnchantmentCount )
	{
		writeChartBarWithStdev( statsEnchantmentCount[count], data.iterations, "#num", maxHeight, columnWidth*columnCount++ + 1, "white", function(p,s){
		return count + " enchantments in "+ parseInt( p *100) +"+-"+parseInt(s*1000)/10+"% of simulated cases";});
	}
	write();
	columnCount=0;
	for( var id in statsSimulateEnchantment )
	{
		var enchantment = _enchantments[id];
		var probabilitySum = 0;
		for( var level in statsSimulateEnchantment[id] )
		{
			writeChartBarWithStdev( statsSimulateEnchantment[id][level], data.iterations, "#sim", maxHeight, columnWidth*columnCount++ +1, enchantment.color, function(p,s){
				probabilitySum += p;
				return enchantment.name + " " + level + " ("+parseInt(p*100)+"+-"+parseInt(s*1000)/10+"%)"; });
		}
		write( "Total probability for " + enchantment.name + ": " + parseInt(probabilitySum*100) + "%" );
	}
}

function ensureVar( target, variable, value )
{
	if( !target.hasOwnProperty( variable ) )
		target[variable] = value;
}

function ensureStatsVars( vars, result )
{
	ensureVar( vars, result.enchantment.id, new Object );
	ensureVar( vars[result.enchantment.id], result.enchantmentLevel, {sum:0,sqsum:0,x:0,n:0} );
}

function updateSum( arr )
{
	for( var id in arr )
	{
		arr[id].sum += arr[id].x;
		arr[id].sqsum += arr[id].x * arr[id].x;
		arr[id].n++;
		arr[id].mean = arr[id].sum / arr[id].n;
		arr[id].variance = ( arr[id].sqsum - (arr[id].sum * arr[id].sum / arr[id].n)) / ( arr[id].n - 1 );
		arr[id].x = 0;
	}
}

function writeChartBarWithStdev( dataset, iterations, divid, maxHeight, yOffset, color, makeInfo)
{
	var percent = dataset.mean / iterations;
	var stdev = Math.sqrt( dataset.variance ) / iterations;

	var info = makeInfo( percent, stdev );
	var upper = maxHeight * (percent + stdev );
	var mean = maxHeight * percent;
	var lower = maxHeight * (percent - stdev );
	$(divid)[0].innerHTML += makeChartBar( info, upper, yOffset, color, 0.2 );
	$(divid)[0].innerHTML += makeChartBar( info, mean, yOffset, color, 0.7 );
	$(divid)[0].innerHTML += makeChartBar( info, lower, yOffset, color, 1 );
	write( info);

}

function makeChartBar( detailmessage, pixelheight, distanceleft, color, opacity)
{
	return "<a title=\""+detailmessage+"\"><div style=\"height:"+ pixelheight +"px;left:"+ distanceleft+"px;opacity:"+opacity+";background-color:"+color+"\"></div></a>";
}

</script>
<style type="text/css">
.textholder, .chartholder
{
border: 1px solid black;
margin: 3em;
padding: 1em;
}
.chartcontainer
{
float:left;
width: 40%;
margin: 2em;
padding: 2em;
}
.textholder
{
	float: right;
	width: 30%;
}
.chartholder
{
	position: relative;
	height: 240px;
	width: 100%;
}

.chartholder div
{
border: 1px solid black;
bottom:1px;
width: 20px;
position:absolute;
}

.debug
{
display:none;
font-size:0.5em;
color: #999;
}
</style>
</head>
<body>
<form>
Material: <select id="material" onChange="simulate()">
<option value="diamond">Diamond</option>
<option value="iron">Iron</option>
<option value="gold">Gold</option>
<option value="leather">Leather</option>
<option value="stone">Stone</option>
<option value="chain">Chainmail</option>
<option value="wood">Wood</option>
</select>
|
Item: <select id="item" onChange="simulate()">
<option value="pickaxe">Pickaxe</option>
<option value="sword">Sword</option>
<option value="axe">Axe</option>
<option value="shovel">Shovel</option>
<option value="helmet">Helmet</option>
<option value="chestplate">Chestplate</option>
<option value="leggings">Leggings</option>
<option value="boots">Boots</option>
</select>
|
Level: <input value="30" id="level" onChange="simulate()" /> <input type="button" onClick="addLevel()" value="+"/> <input type="button" onClick="removeLevel()" value="-" /> | 
Simulations: <input id="trials" onChange="simulate()" /> | <input type="button" onClick="simulate()" value="Go"/>
</form>
<div class="chartcontainer">

Probability that enchantment will be included:
<div class="chartholder" id="sim"></div>

Probability to get N enchantments:
<div class="chartholder" id="num"></div>

</div>
<div class="textholder" id="output"></div>
</body>
</html>